<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Recetas de Panadería</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    select, input, textarea, button { margin: 5px 0; padding: 8px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .section { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Gestor de Recetas de Panadería</h1>

  <!-- Selección de recetas -->
  <div class="section">
    <label for="recipeSelect">Seleccionar Receta:</label>
    <select id="recipeSelect"></select>
  </div>

  <!-- Ajuste de peso total -->
  <div class="section">
    <label for="doughWeight">Peso de Masa (g):</label>
    <input type="number" id="doughWeight" value="1000" min="1" />
    <button onclick="calculateGrams()">Recalcular Ingredientes</button>
  </div>

  <!-- Tabla de ingredientes -->
  <div class="section">
    <table id="ingredientsTable">
      <thead>
        <tr><th>Ingrediente</th><th>% Panadero</th><th>Peso (g)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Instrucciones -->
  <div class="section">
    <h3>Instrucciones</h3>
    <p id="instructions"></p>
  </div>

  <!-- Tiempos -->
  <div class="section">
    <h3>Tiempos</h3>
    <p id="times"></p>
  </div>

  <!-- Formulario para agregar receta -->
  <div class="section">
    <h2>Nueva Receta</h2>
    <input type="text" id="newRecipeName" placeholder="Nombre de la receta" />
    <textarea id="newRecipeInstructions" placeholder="Instrucciones"></textarea>
    <textarea id="newRecipeTimes" placeholder="Tiempos"></textarea>
    <h4>Ingredientes</h4>
    <div id="ingredientsList"></div>
    <button onclick="addIngredient()">Agregar Ingrediente</button>
    <button onclick="saveRecipe()">Guardar Receta</button>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ⚠️ Tus credenciales Firebase (no borrar)
    const firebaseConfig = {
      apiKey: "AIzaSyC6RrF6-gZtpxxFx3G4S0-pm5R5G9L2Ytk",
      authDomain: "recetaspanaderia-b31f2.firebaseapp.com",
      projectId: "recetaspanaderia-b31f2",
      storageBucket: "recetaspanaderia-b31f2.appspot.com",
      messagingSenderId: "1029384756",
      appId: "1:1029384756:web:abc123def456"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let recipes = [];

    async function loadRecipes() {
      recipes = [];
      const snapshot = await getDocs(collection(db, "recipes"));
      snapshot.forEach(doc => recipes.push({ id: doc.id, ...doc.data() }));
      populateSelect();
    }

    function populateSelect() {
      const select = document.getElementById("recipeSelect");
      select.innerHTML = "<option value=''>--Selecciona--</option>";
      recipes.forEach((r, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = r.name;
        select.appendChild(opt);
      });
    }

    function displayRecipe(recipe) {
      if (!recipe) return;
      const tbody = document.querySelector('#ingredientsTable tbody');
      tbody.innerHTML = '';

      const totalDough = parseFloat(document.getElementById('doughWeight').value) || 1000;
      const sumPerc = (recipe.ingredients || []).reduce((sum, ing) => sum + (parseFloat(ing.percent) || 0), 0);
      const flourWeight = (totalDough / sumPerc) * 100;

      (recipe.ingredients || []).forEach(ing => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = ing.name;
        row.insertCell(1).textContent = Number(ing.percent).toString().replace('.', ',') + '%';
        const grams = (parseFloat(ing.percent) || 0) / 100 * flourWeight;
        row.insertCell(2).textContent = Math.round(grams) + ' g';
      });

      document.getElementById('instructions').textContent = recipe.instructions || '';
      document.getElementById('times').textContent = recipe.times || '';
    }

    function calculateGrams() {
      const idx = document.getElementById('recipeSelect').value;
      if (idx === '') return;
      displayRecipe(recipes[Number(idx)]);
    }

    // ===== Agregar nueva receta =====
    function addIngredient() {
      const container = document.getElementById('ingredientsList');
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="text" placeholder="Ingrediente" class="ingName"/>
        <input type="number" placeholder="% Panadero" class="ingPercent"/>
      `;
      container.appendChild(div);
    }

    async function saveRecipe() {
      const name = document.getElementById('newRecipeName').value.trim();
      if (!name) return alert("Escribe un nombre para la receta");
      const instructions = document.getElementById('newRecipeInstructions').value.trim();
      const times = document.getElementById('newRecipeTimes').value.trim();

      const ingNodes = document.querySelectorAll('#ingredientsList div');
      const ingredients = [];
      ingNodes.forEach(div => {
        const ingName = div.querySelector('.ingName').value.trim();
        const ingPercent = parseFloat(div.querySelector('.ingPercent').value);
        if (ingName && !isNaN(ingPercent)) {
          ingredients.push({ name: ingName, percent: ingPercent });
        }
      });

      try {
        await addDoc(collection(db, "recipes"), { name, instructions, times, ingredients });
        alert("Receta guardada con éxito");
        loadRecipes();
      } catch (e) {
        console.error("Error guardando receta: ", e);
      }
    }

    // Eventos
    document.getElementById("recipeSelect").addEventListener("change", e => {
      const idx = e.target.value;
      if (idx !== '') displayRecipe(recipes[Number(idx)]);
    });

    window.addIngredient = addIngredient;
    window.saveRecipe = saveRecipe;
    window.calculateGrams = calculateGrams;

    // Cargar al inicio
    loadRecipes();
  </script>
</body>
</html>
