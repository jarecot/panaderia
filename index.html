<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Gestor de Recetas de Panadería</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input, select, textarea { width: 100%; padding: 6px; margin: 5px 0; box-sizing: border-box; }
    button { padding: 10px; margin: 5px 5px 5px 0; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 6px; }
    button:hover { filter: brightness(0.95); }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.4); }
    .modal-content { background: white; margin: 7% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .ingredient-row { display:flex; gap:8px; margin: 6px 0; }
    .ingredient-row input[type="text"]{ flex:1; }
    .ingredient-row input[type="number"]{ width:120px; }
    .delete-ing { background: #f44336; padding: 6px 10px; border-radius: 6px; color: white; border: none; }
    .danger { background: #f44336; }
    #status { margin: 8px 0; color: #333; }
  </style>
</head>
<body>
  <h1>Gestor de Recetas de Panadería</h1>

  <label for="recipeSelect">Seleccionar Receta:</label>
  <select id="recipeSelect">
    <option value="">-- Elige una receta --</option>
  </select>

  <br /><br />

  <label for="flourWeight">Peso de Harina (g):</label>
  <input type="number" id="flourWeight" value="1000" min="1" />

  <h2>Ingredientes</h2>
  <table id="ingredientsTable">
    <thead>
      <tr><th>Ingrediente</th><th>Porcentaje (%)</th><th>Gramos</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Instrucciones</h2>
  <div id="instructions"></div>

  <h2>Tiempos</h2>
  <div id="times"></div>

  <div style="margin-top:12px;">
    <button onclick="openModal('add')">Agregar Nueva Receta</button>
    <button onclick="editSelectedRecipe()">Editar Receta Seleccionada</button>
    <button id="importBtn" style="display:none" onclick="importLocalRecipesToFirestore()">Importar recipes.json a Firestore</button>
    <button class="danger" onclick="clearRecipes()">Borrar Todas las Recetas</button>
  </div>

  <div id="status"></div>

  <!-- Modal -->
  <div id="recipeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Agregar Nueva Receta</h2>
      <label>Nombre:</label>
      <input type="text" id="recipeName" />

      <h3>Ingredientes</h3>
      <div id="ingredientsList"></div>
      <button type="button" onclick="addIngredientRow()">Agregar Ingrediente</button>

      <label>Instrucciones:</label>
      <textarea id="instructionsText" rows="5"></textarea>

      <label>Tiempos (fermentación/horneado):</label>
      <input type="text" id="timesText" placeholder="Ej: Fermentación: 4h bulk + 12h cold; Horneado: 50min a 230°C" />

      <div style="margin-top:10px;">
        <button onclick="saveRecipe()">Guardar Receta</button>
        <button onclick="closeModal()" style="background:#888">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ======= Reemplaza por tu configuración de Firebase si es diferente =======
    const firebaseConfig = {
      apiKey: "AIzaSyAhzdmVFlvtoqMSfIQ6OCbiYdg6s6c95iY",
      authDomain: "recetaspanaderia-b31f2.firebaseapp.com",
      projectId: "recetaspanaderia-b31f2",
      storageBucket: "recetaspanaderia-b31f2.appspot.com",
      messagingSenderId: "979143269695",
      appId: "1:979143269695:web:678dc20bf48fc71700078a"
    };
    // ==========================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let recipes = []; // array cargado (desde Firestore o desde recipes.json)
    let editingIndex = -1;

    const statusEl = document.getElementById('status');

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || '';
      statusEl.style.color = isError ? '#b00020' : '#333';
    }

    async function loadRecipes() {
      setStatus('Cargando recetas desde Firestore...');
      try {
        const snap = await getDocs(collection(db, "recipes"));
        recipes = [];
        snap.forEach(d => recipes.push({ id: d.id, ...d.data() }));

        if (recipes.length === 0) {
          // Si Firestore está vacío, intentamos cargar recipes.json local
          setStatus('No hay recetas en Firestore. Intentando cargar recipes.json local...');
          try {
            const resp = await fetch('recipes.json');
            if (resp.ok) {
              const local = await resp.json();
              // marcamos id=null para indicar que vienen del JSON local (no del servidor)
              recipes = local.map(r => ({ id: null, ...r }));
              populateSelect(recipes);
              document.getElementById('importBtn').style.display = 'inline-block';
              setStatus('Se cargaron recetas desde recipes.json. Puedes importarlas a Firestore con el botón "Importar recipes.json a Firestore".');
              return;
            } else {
              setStatus('No se encontró recipes.json local (respuesta ' + resp.status + ').', true);
            }
          } catch (err) {
            setStatus('Error al cargar recipes.json local: ' + err.message, true);
          }
        }

        // Si sí hay datos en Firestore o la carga local falló
        populateSelect(recipes);
        document.getElementById('importBtn').style.display = 'none';
        setStatus('Recetas cargadas (' + recipes.length + ')');
      } catch (err) {
        console.error(err);
        setStatus('Error al cargar recetas desde Firestore: ' + err.message, true);
      }
    }

    function populateSelect(list) {
      const select = document.getElementById('recipeSelect');
      select.innerHTML = '<option value="">-- Elige una receta --</option>';
      list.forEach((r, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = r.name || ('Receta ' + (i+1));
        select.appendChild(opt);
      });
      // limpiar vista
      document.getElementById('recipeSelect').value = '';
      document.querySelector('#ingredientsTable tbody').innerHTML = '';
      document.getElementById('instructions').textContent = '';
      document.getElementById('times').textContent = '';
    }

    document.getElementById('recipeSelect').addEventListener('change', function() {
      const index = this.value;
      if (index === '') return;
      displayRecipe(recipes[parseInt(index)]);
    });

    document.getElementById('flourWeight').addEventListener('input', calculateGrams);

    function displayRecipe(recipe) {
      const tbody = document.querySelector('#ingredientsTable tbody');
      tbody.innerHTML = '';
      (recipe.ingredients || []).forEach(ing => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = ing.name;
        row.insertCell(1).textContent = (typeof ing.percent === 'number' ? ing.percent : parseFloat(ing.percent)) + '%';
        const grams = ( (parseFloat(ing.percent) || 0) / 100 * (parseFloat(document.getElementById('flourWeight').value) || 1000) );
        row.insertCell(2).textContent = Math.round(grams) + 'g';
      });
      document.getElementById('instructions').textContent = recipe.instructions || '';
      document.getElementById('times').textContent = recipe.times || '';
      calculateGrams();
    }

    function calculateGrams() {
      const flourWeight = parseFloat(document.getElementById('flourWeight').value) || 1000;
      document.querySelectorAll('#ingredientsTable tbody tr').forEach(row => {
        // parseFloat funciona aunque el texto tenga '%' o 'g'
        const percent = parseFloat(row.cells[1].textContent) || 0;
        row.cells[2].textContent = Math.round(percent / 100 * flourWeight) + 'g';
      });
    }

    function openModal(mode, index = -1) {
      editingIndex = index;
      const modal = document.getElementById('recipeModal');
      const title = document.getElementById('modalTitle');
      if (mode === 'edit' && index >= 0) {
        title.textContent = 'Editar Receta';
        const recipe = recipes[index];
        document.getElementById('recipeName').value = recipe.name || '';
        document.getElementById('instructionsText').value = recipe.instructions || '';
        document.getElementById('timesText').value = recipe.times || '';
        loadIngredientsToModal(recipe.ingredients || []);
      } else {
        title.textContent = 'Agregar Nueva Receta';
        document.getElementById('recipeName').value = '';
        document.getElementById('instructionsText').value = '';
        document.getElementById('timesText').value = '';
        loadIngredientsToModal([{name: '', percent: 0}]);
      }
      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('recipeModal').style.display = 'none';
    }

    function loadIngredientsToModal(ingredients) {
      const list = document.getElementById('ingredientsList');
      list.innerHTML = '';
      (ingredients.length ? ingredients : [{name:'', percent:0}]).forEach(ing => addIngredientRow(ing.name || '', ing.percent || 0));
    }

    function addIngredientRow(name = '', percent = 0) {
      const list = document.getElementById('ingredientsList');
      const row = document.createElement('div');
      row.className = 'ingredient-row';
      row.innerHTML = `
        <input type="text" placeholder="Ingrediente" value="${escapeHtml(name)}" />
        <input type="number" placeholder="%" value="${percent}" min="0" step="0.1" />
        <button class="delete-ing" type="button">Borrar</button>
      `;
      row.querySelector('.delete-ing').onclick = () => row.remove();
      list.appendChild(row);
    }

    // pequeña función para evitar inyección accidental en valores presentados
    function escapeHtml(s) {
      return String(s || '').replaceAll('"', '&quot;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    async function saveRecipe() {
      const name = document.getElementById('recipeName').value.trim();
      if (!name) return alert('Nombre requerido');

      const ingredients = [];
      document.querySelectorAll('.ingredient-row').forEach(row => {
        const nameIn = row.querySelector('input[type="text"]').value.trim();
        const percent = parseFloat(row.querySelector('input[type="number"]').value) || 0;
        if (nameIn && percent > 0) ingredients.push({ name: nameIn, percent });
      });
      if (ingredients.length === 0) return alert('Al menos un ingrediente requerido');

      const recipe = {
        name,
        ingredients,
        instructions: document.getElementById('instructionsText').value,
        times: document.getElementById('timesText').value
      };

      setStatus('Guardando receta...');
      try {
        if (editingIndex >= 0) {
          const localRecipe = recipes[editingIndex];
          if (localRecipe && localRecipe.id) {
            // actualizamos documento existente
            await updateDoc(doc(db, "recipes", localRecipe.id), recipe);
            setStatus('Receta actualizada en Firestore.');
          } else {
            // venía del recipes.json local -> creamos nuevo documento
            await addDoc(collection(db, "recipes"), recipe);
            setStatus('Receta creada en Firestore.');
          }
        } else {
          // nuevo
          await addDoc(collection(db, "recipes"), recipe);
          setStatus('Receta creada en Firestore.');
        }
        closeModal();
        await loadRecipes();
      } catch (err) {
        console.error(err);
        setStatus('Error al guardar receta: ' + err.message, true);
      }
    }

    function editSelectedRecipe() {
      const index = document.getElementById('recipeSelect').value;
      if (index === '') return alert('Selecciona una receta primero');
      openModal('edit', parseInt(index));
    }

    async function clearRecipes() {
      if (!confirm('¿Borrar todas las recetas? Esta acción eliminará los documentos en Firestore.')) return;
      setStatus('Eliminando recetas...');
      try {
        // cargamos de nuevo para tener ids
        const snap = await getDocs(collection(db, "recipes"));
        const docs = [];
        snap.forEach(d => docs.push(d.id));
        for (const id of docs) {
          await deleteDoc(doc(db, "recipes", id));
        }
        await loadRecipes();
        setStatus('Todas las recetas borradas.');
      } catch (err) {
        console.error(err);
        setStatus('Error borrando recetas: ' + err.message, true);
      }
    }

    window.onclick = function(event) {
      const modal = document.getElementById('recipeModal');
      if (event.target == modal) closeModal();
    };

    // ===== Importador one-time desde recipes.json (útil para poblar Firestore inicial) =====
    async function importLocalRecipesToFirestore() {
      if (!confirm('Importar recipes.json a Firestore (crear documentos) ?')) return;
      setStatus('Importando recipes.json a Firestore... Esto puede tardar unos segundos.');
      try {
        const resp = await fetch('recipes.json');
        if (!resp.ok) throw new Error('No se pudo leer recipes.json (status ' + resp.status + ')');
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error('recipes.json no contiene un array de recetas.');
        for (const r of data) {
          // simple validación mínima
          if (!r.name) continue;
          await addDoc(collection(db, "recipes"), r);
        }
        setStatus('Importación completa. Recargando recetas desde Firestore...');
        await loadRecipes();
      } catch (err) {
        console.error(err);
        setStatus('Error importando recipes.json: ' + err.message, true);
        alert('Error importando recipes.json: ' + err.message);
      }
    }
    // =====================================================================================

    // inicializar
    loadRecipes();

  </script>
</body>
</html>
