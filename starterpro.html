<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora FermentaPro ‚Äì Starter y Recetas Avanzadas</title>
    <!-- Tailwind CSS CDN para un dise√±o moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definici√≥n de colores base en CSS para mantener la est√©tica panadera */
        :root {
            --color-base: #8b5e3c; /* Tostado / Marr√≥n oscuro */
            --color-acento: #d6ad60; /* Amarillo trigo / Dorado */
            --color-fondo: #fffaf2; /* Fondo Crema suave */
            --color-texto: #3a2e1f; /* Marr√≥n oscuro para texto */
        }
        
        /* Configuraci√≥n global de la fuente y fondo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
        }

        /* Estilos personalizados de Tailwind */
        .input-style {
            @apply w-full p-3 mt-1 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-[color:var(--color-base)] focus:border-[color:var(--color-base)] transition duration-150;
        }
        .btn-base {
            @apply bg-[color:var(--color-base)] text-white font-semibold py-3 px-6 rounded-xl transition duration-300 w-full hover:bg-[color:var(--color-acento)] hover:text-[color:var(--color-texto)] shadow-md hover:shadow-lg;
        }
        .btn-secondary {
            @apply bg-transparent text-[color:var(--color-base)] border-2 border-[color:var(--color-base)] hover:bg-[color:var(--color-base)] hover:text-white mt-4;
        }
        .section-header {
            /* Mayor separaci√≥n vertical y espaciado */
            @apply text-xl font-bold text-[color:var(--color-base)] mt-10 mb-6 border-b border-gray-200 pb-2 flex justify-between items-center cursor-pointer;
        }
        .result-box {
            @apply bg-[color:var(--color-acento)] text-[color:var(--color-texto)] p-5 rounded-xl mt-6 text-left shadow-lg;
        }

        /* ------------------------------------------------------------------ */
        /* FIX: Estilos para Tooltip - Asegura que solo se muestre al hacer hover */
        /* ------------------------------------------------------------------ */
        .tooltip-container {
            @apply relative inline-block w-full;
        }
        .tooltip-icon {
            @apply ml-1 text-gray-500 cursor-help hover:text-[color:var(--color-base)];
        }
        .tooltip-text {
            /* z-50 para asegurar que est√© encima de todo */
            /* top-full mt-2: Posiciona debajo del icono */
            @apply absolute z-50 bg-gray-800 text-white text-xs rounded py-1 px-2 pointer-events-none w-max max-w-xs shadow-lg left-1/2 transform -translate-x-1/2 top-full mt-2;
            display: none; /* OCULTO por defecto */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .tooltip-container:hover .tooltip-text {
            display: block; /* Muestra el tooltip al hacer hover */
            opacity: 1;
        }

        /* Clase para el contenedor de secciones colapsables */
        .collapsible-body {
            max-height: 1000px; /* Suficientemente grande para el contenido */
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-body.collapsed {
            max-height: 0;
            overflow: hidden;
        }
    </style>
</head>

<body class="flex justify-center items-start min-h-screen py-8">
    <div id="app-container" class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 max-w-xl w-11/12 text-center">
        
        <!-- HEADER -->
        <h1 class="text-3xl font-extrabold text-[color:var(--color-base)] mb-2">FermentaPro</h1>
        <p class="text-gray-500 mb-8 text-base">Calculadora de Starter y Ajuste de Recetas.</p>
        
        <!-- Mensaje de Error (Reemplaza el alert()) -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4 text-sm font-medium" role="alert">
            <!-- El mensaje de error se inyecta aqu√≠ -->
        </div>

        <!-- SECCI√ìN 1: C√ÅLCULO DE STARTER -->
        <h2 class="section-header" onclick="toggleSection('starter-section-body', 'toggle-icon-starter')">
            1. Calcular Proporci√≥n de Starter
            <span id="toggle-icon-starter" class="transform transition-transform rotate-0">‚ñº</span>
        </h2>
        
        <div id="starter-section-body" class="collapsible-body">
            
            <div class="mb-6">
                <label for="tipoPrefermento" class="block text-left font-semibold mt-4">Tipo de Prefermento:</label>
                <select id="tipoPrefermento" onchange="aplicarPreset()" class="input-style">
                    <option value="personalizado">üîß Personalizado</option>
                    <!-- Los presets ya est√°n definidos con el nuevo formato S:H:A -->
                    <option value="levain">Levain (1:1:1 ‚Äì 100%)</option>
                    <option value="poolish">Poolish (1:1:1 ‚Äì 100%)</option>
                    <option value="biga">Biga (1:0.45:0.45 ‚Äì 45%)</option>
                    <option value="masaMadreSolida">Masa madre s√≥lida (1:0.5:0.5 ‚Äì 50%)</option>
                    <option value="esponja">Esponja (1:0.6:0.6 ‚Äì 60%)</option>
                </select>
            </div>
        
            <div class="mb-6">
                <label for="starterTotal" class="block text-left font-semibold">Cantidad total de starter necesaria (g)</label>
                <input type="number" id="starterTotal" placeholder="Ej: 100" step="1" class="input-style">
            </div>

            <div class="mb-6">
                <!-- ETIQUETA ACTUALIZADA A STARTER:HARINA:AGUA -->
                <label for="proporcion" class="block text-left font-semibold">Proporci√≥n (Starter Madre : Harina Nueva : Agua Nueva):</label>
                <input type="text" id="proporcion" placeholder="Ej: 1:5:2.5" class="input-style">
            </div>

            <div class="mb-6">
                <label for="hidratacionMadre" class="block text-left font-semibold">Hidrataci√≥n del starter madre (%):</label>
                <input type="number" id="hidratacionMadre" step="1" placeholder="Ej: 100" class="input-style">
            </div>
        
            <button onclick="calcularStarter()" class="btn-base mt-2">CALCULAR STARTER</button>
        
            <div id="resultado-starter" class="result-box hidden"></div>
        </div>

        <!-- SECCI√ìN 2: RECALCULADORA DE RECETAS -->
        <h2 class="section-header" onclick="toggleSection('recalce-section-body', 'toggle-icon-recalce')">
            2. Recalcular Receta y Ajuste de Ingredientes
            <span id="toggle-icon-recalce" class="transform transition-transform rotate-180">‚ñº</span>
        </h2>

        <div id="recalce-section-body" class="collapsible-body">
            <!-- INPUTS RECETA ORIGINAL -->
            <p class="text-sm text-gray-600 mb-4">Paso 1: Define tu receta original para calcular su hidrataci√≥n real.</p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="tooltip-container">
                    <label for="recetaHarina" class="block text-left text-sm font-medium">Harina principal (g) <span class="tooltip-icon">‚ìò<span class="tooltip-text">Harina que se a√±ade a la masa principal. NO incluye la harina del starter. (Ej: 1000g)</span></span></label>
                    <input type="number" id="recetaHarina" placeholder="1000" class="input-style p-2 text-base">
                </div>
                <div class="tooltip-container">
                    <label for="recetaLiquido" class="block text-left text-sm font-medium">L√≠quido principal (g) <span class="tooltip-icon">‚ìò<span class="tooltip-text">Agua, leche u otro l√≠quido que se a√±ade a la masa principal. NO incluye el l√≠quido del starter. (Ej: 600g)</span></span></label>
                    <input type="number" id="recetaLiquido" placeholder="600" class="input-style p-2 text-base">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="tooltip-container">
                    <label for="starterOriginal" class="block text-left text-sm font-medium">Starter Original (g) <span class="tooltip-icon">‚ìò<span class="tooltip-text">La cantidad de starter que usas en la receta original. (Ej: 200g)</span></span></label>
                    <input type="number" id="starterOriginal" placeholder="200" class="input-style p-2 text-base">
                </div>
                <div class="tooltip-container">
                    <label for="hidratacionOriginal" class="block text-left text-sm font-medium">Hidrataci√≥n Original (%) <span class="tooltip-icon">‚ìò<span class="tooltip-text">La hidrataci√≥n del starter que usas en la receta original. (Ej: 100% para 1:1)</span></span></label>
                    <input type="number" id="hidratacionOriginal" placeholder="100" class="input-style p-2 text-base">
                </div>
            </div>

            <!-- INPUTS STARTER OBJETIVO -->
            <p class="text-sm text-gray-600 mt-6 mb-4 border-t pt-4">Paso 2: Define el nuevo starter que usar√°s en tu receta.</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="tooltip-container">
                    <label for="starterObjetivo" class="block text-left text-sm font-medium">Starter Objetivo (g) <span class="tooltip-icon">‚ìò<span class="tooltip-text">La cantidad del nuevo starter que deseas usar. (Ej: 100g)</span></span></label>
                    <input type="number" id="starterObjetivo" placeholder="100" class="input-style p-2 text-base">
                </div>
                <div class="tooltip-container">
                    <label for="hidratacionObjetivo" class="block text-left text-sm font-medium">Hidrataci√≥n Objetivo (%) <span class="tooltip-icon">‚ìò<span class="tooltip-text">La hidrataci√≥n del nuevo starter. (Ej: 50% para una masa madre s√≥lida)</span></span></label>
                    <input type="number" id="hidratacionObjetivo" placeholder="50" class="input-style p-2 text-base">
                </div>
            </div>
            
            <!-- Bot√≥n y Resultado -->
            <button onclick="recalcularReceta()" class="btn-base mt-2">RECALCULAR Y AJUSTAR</button>

            <div id="resultado-recalce" class="result-box hidden"></div>

        </div>

        <!-- Bot√≥n de Limpiar / Footer -->
        <button onclick="clearForms()" class="btn-base btn-secondary mt-10 text-sm md:text-base">
            üóëÔ∏è Limpiar todos los campos
        </button>
        
        <footer class="mt-8 text-xs text-gray-400">
            &copy; 2025 FermentaPro
        </footer>
    </div>

    <script>
        // Funci√≥n para mostrar errores en el UI
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById("error-message");
            errorDiv.textContent = '‚ö†Ô∏è Error: ' + mensaje;
            errorDiv.classList.remove("hidden");
            errorDiv.scrollIntoView({ behavior: 'smooth' }); // Desplazar al error
            setTimeout(() => errorDiv.classList.add("hidden"), 7000); 
        }
        
        // Funci√≥n para limpiar todos los formularios
        function clearForms() {
            document.getElementById("starterTotal").value = '';
            document.getElementById("proporcion").value = '';
            document.getElementById("hidratacionMadre").value = '';
            document.getElementById("tipoPrefermento").value = 'personalizado';
            document.getElementById("recetaHarina").value = '';
            document.getElementById("recetaLiquido").value = '';
            document.getElementById("starterOriginal").value = '';
            document.getElementById("hidratacionOriginal").value = '';
            document.getElementById("starterObjetivo").value = '';
            document.getElementById("hidratacionObjetivo").value = '';

            document.getElementById("resultado-starter").classList.add("hidden");
            document.getElementById("resultado-recalce").classList.add("hidden");
            document.getElementById("error-message").classList.add("hidden");
        }

        // Funci√≥n para alternar la visibilidad de las secciones
        function toggleSection(bodyId, iconId) {
            const body = document.getElementById(bodyId);
            const icon = document.getElementById(iconId);
            
            body.classList.toggle('collapsed');

            if (body.classList.contains('collapsed')) {
                icon.classList.remove('rotate-180');
                icon.classList.add('rotate-0');
            } else {
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-180');
            }
        }

        // Inicializar la rotaci√≥n de los iconos al cargar
        document.addEventListener('DOMContentLoaded', () => {
             // Dejar la secci√≥n 2 abierta por defecto
             document.getElementById('starter-section-body').classList.add('collapsed');
             document.getElementById('toggle-icon-starter').classList.add('rotate-0');

             document.getElementById('recalce-section-body').classList.remove('collapsed');
             document.getElementById('toggle-icon-recalce').classList.add('rotate-180');
        });

        // ----------------------------------------------------
        // SECCI√ìN 1: C√ÅLCULO DE STARTER (L√ìGICA ACTUALIZADA)
        // ----------------------------------------------------

        function aplicarPreset() {
            const tipo = document.getElementById("tipoPrefermento").value;
            const proporcion = document.getElementById("proporcion");
            const hidratacionMadre = document.getElementById("hidratacionMadre");

            // Los presets ahora reflejan: Starter : Harina : Agua
            switch (tipo) {
                case "levain":
                case "poolish":
                    proporcion.value = "1:1:1"; // 1 starter : 1 harina : 1 agua
                    hidratacionMadre.value = 100;
                    break;
                case "biga":
                    proporcion.value = "1:0.45:0.45";
                    hidratacionMadre.value = 45;
                    break;
                case "masaMadreSolida":
                    proporcion.value = "1:0.5:0.5";
                    hidratacionMadre.value = 50;
                    break;
                case "esponja":
                    proporcion.value = "1:0.6:0.6";
                    hidratacionMadre.value = 60;
                    break;
                default:
                    proporcion.value = "";
                    hidratacionMadre.value = "";
            }
        }

        function calcularStarter() {
            const total = parseFloat(document.getElementById("starterTotal").value);
            const proporcionStr = document.getElementById("proporcion").value.trim();
            const hidratacionMadre = parseFloat(document.getElementById("hidratacionMadre").value);
            const resultadoDiv = document.getElementById("resultado-starter");

            resultadoDiv.classList.add("hidden");

            if (isNaN(total) || !proporcionStr || isNaN(hidratacionMadre) || total <= 0 || hidratacionMadre < 0) {
                mostrarError("Aseg√∫rate de que la cantidad total de starter y la hidrataci√≥n sean n√∫meros positivos, y que la proporci√≥n est√© completa.");
                return;
            }

            const partes = proporcionStr.split(":").map(parseFloat);
            if (partes.length !== 3 || partes.some(isNaN)) {
                // Mensaje actualizado para el nuevo formato
                mostrarError("Formato de proporci√≥n inv√°lido. Usa el formato StarterMadre:HarinaNueva:AguaNueva (Ej: 1:5:2.5).");
                return;
            }

            // [0] Starter Madre, [1] Harina Nueva, [2] Agua Nueva
            const [pStarterMadre, pHarinaNueva, pAguaNueva] = partes;
            
            if (pStarterMadre <= 0 || pHarinaNueva < 0 || pAguaNueva < 0) {
                 mostrarError("La proporci√≥n de Starter Madre debe ser mayor a 0. Harina y Agua pueden ser 0.");
                 return;
            }

            // La suma de partes es la suma de los tres componentes
            const totalPartes = pStarterMadre + pHarinaNueva + pAguaNueva;
            const factor = total / totalPartes;

            // Ingredientes nuevos para crear el starter final
            const starterMadre = pStarterMadre * factor;
            const harinaNueva = pHarinaNueva * factor;
            const aguaNueva = pAguaNueva * factor;

            // Calcular agua y harina provenientes del starter madre
            const ratio = 1 + (hidratacionMadre / 100);
            // Si la hidrataci√≥n madre es 0, toda la masa madre es harina
            const harinaMadre = hidratacionMadre === 0 ? starterMadre : starterMadre / ratio;
            const aguaMadre = starterMadre - harinaMadre;

            // Totales efectivos en el starter resultante
            const harinaTotalStarter = harinaNueva + harinaMadre;
            const aguaTotalStarter = aguaNueva + aguaMadre;
            
            // Si la harina total es 0, la hidrataci√≥n es indefinida (aunque deber√≠a ser 0 si todos los inputs son 0)
            const hidratacionFinal = harinaTotalStarter > 0 ? (aguaTotalStarter / harinaTotalStarter) * 100 : 0;

            resultadoDiv.classList.remove("hidden");
            resultadoDiv.innerHTML = `
                <p class="font-bold text-lg mb-2 text-[color:var(--color-base)]">‚úÖ Ingredientes para tu Nuevo Lote de Starter</p>
                <ul class="list-disc list-inside text-gray-800 space-y-1">
                    <li>üß´ Starter madre: <strong>${starterMadre.toFixed(1)} g</strong></li>
                    <li>üåæ Harina nueva: <strong>${harinaNueva.toFixed(1)} g</strong></li>
                    <li>üíß Agua nueva: <strong>${aguaNueva.toFixed(1)} g</strong></li>
                </ul>
                <div class="mt-3 pt-2 border-t border-gray-300">
                    <p class="text-sm font-semibold">Harina total en el nuevo starter: ${harinaTotalStarter.toFixed(1)} g</p>
                    <p class="text-sm font-semibold">Agua total en el nuevo starter: ${aguaTotalStarter.toFixed(1)} g</p>
                    <p class="text-xl font-extrabold text-[color:var(--color-base)] mt-1">Hidrataci√≥n final: ${hidratacionFinal.toFixed(1)} %</p>
                </div>
            `;
        }

        // ----------------------------------------------------
        // SECCI√ìN 2: RECALCULADORA DE RECETAS (Sin cambios)
        // ----------------------------------------------------

        // Funci√≥n para calcular Harina y L√≠quido aportados por el starter
        function calcularComponentesStarter(cantidadStarter, hidratacion) {
            // F = S / (1 + H/100)
            if (hidratacion < 0) return { flour: 0, liquid: 0 };
            const ratio = 1 + (hidratacion / 100);
            const flour = cantidadStarter / ratio;
            const liquid = cantidadStarter - flour;
            return { flour, liquid };
        }

        function recalcularReceta() {
            // Receta Original
            const RF_O = parseFloat(document.getElementById("recetaHarina").value);
            const RL_O = parseFloat(document.getElementById("recetaLiquido").value);
            const S_O = parseFloat(document.getElementById("starterOriginal").value);
            const H_S_O = parseFloat(document.getElementById("hidratacionOriginal").value);

            // Starter Objetivo (Nuevo)
            const S_T = parseFloat(document.getElementById("starterObjetivo").value);
            const H_S_T = parseFloat(document.getElementById("hidratacionObjetivo").value);

            const resultadoDiv = document.getElementById("resultado-recalce");
            resultadoDiv.classList.add("hidden");

            // Validaci√≥n robusta
            const inputs = [RF_O, RL_O, S_O, S_T, H_S_O, H_S_T];
            if (inputs.some(isNaN) || RF_O <= 0 || S_O <= 0 || S_T <= 0 || H_S_O < 0 || H_S_T < 0) {
                mostrarError("Por favor, ingresa valores num√©ricos positivos en todos los campos (la hidrataci√≥n puede ser 0).");
                return;
            }

            // 1. Componentes del Starter Original
            const starterOriginal = calcularComponentesStarter(S_O, H_S_O);
            const F_S_O = starterOriginal.flour; // Harina aportada por el starter original
            const L_S_O = starterOriginal.liquid; // L√≠quido aportado por el starter original

            // 2. Totales efectivos en la masa original (Definen la hidrataci√≥n final de la masa)
            const F_Total_O = RF_O + F_S_O; // Harina total efectiva en la masa
            const L_Total_O = RL_O + L_S_O; // L√≠quido total efectivo en la masa

            if (F_Total_O <= 0) {
                 mostrarError("La harina total efectiva de la masa es cero o negativa. Revisa tus inputs.");
                 return;
            }
            
            // C√°lculo preciso de la Hidrataci√≥n Final de la Masa Deseada
            const H_Dough = (L_Total_O / F_Total_O) * 100;

            // 3. Componentes del Starter Objetivo (Nuevo)
            const starterObjetivo = calcularComponentesStarter(S_T, H_S_T);
            const F_S_T = starterObjetivo.flour; // Harina aportada por el starter objetivo
            const L_S_T = starterObjetivo.liquid; // L√≠quido aportado por el starter objetivo

            // 4. Calcular los nuevos requerimientos para la Harina y L√≠quido de la Receta (Main Dough)
            const RF_Adjusted = F_Total_O - F_S_T;
            const RL_Adjusted = L_Total_O - L_S_T;
            
            // Validar que los nuevos requerimientos no sean negativos
            if (RF_Adjusted < 0 || RL_Adjusted < 0) {
                mostrarError(`Receta Inviable: El starter objetivo (${S_T}g) aporta demasiados ingredientes. Reduce su cantidad o ajusta la receta original.`);
                return;
            }

            // 5. Calcular los ajustes (Diferencia con la harina original)
            const adjustmentHarina = RF_Adjusted - RF_O;
            const adjustmentLiquido = RL_Adjusted - RL_O;
            
            // Funci√≥n auxiliar para formatear los ajustes
            const formatAdjustment = (value) => {
                const sign = value >= 0 ? "+" : "";
                const color = value >= 0 ? 'text-green-700' : 'text-red-700';
                return `<span class="font-bold ${color}">${sign}${value.toFixed(1)} g</span>`;
            };

            // Mostrar Resultados
            resultadoDiv.classList.remove("hidden");
            resultadoDiv.innerHTML = `
                <p class="font-bold text-lg mb-3 text-[color:var(--color-base)]">‚öñÔ∏è AJUSTE DE RECETA EXITOSO</p>

                <p class="text-sm font-semibold mb-3">La hidrataci√≥n final de tu masa se mantendr√° en: <strong class="text-xl text-[color:var(--color-base)]">${H_Dough.toFixed(2)} %</strong></p>
                
                <h3 class="font-extrabold text-base mb-2 border-b border-gray-300 pb-1">DATOS ORIGINALES DE LA MASA:</h3>
                <div class="space-y-1 text-sm text-gray-700">
                    <p>üåæ Harina Total Efectiva: <strong>${F_Total_O.toFixed(1)} g</strong> (${RF_O}g Receta + ${F_S_O.toFixed(1)}g Starter)</p>
                    <p>üíß L√≠quido Total Efectivo: <strong>${L_Total_O.toFixed(1)} g</strong> (${RL_O}g Receta + ${L_S_O.toFixed(1)}g Starter)</p>
                </div>

                <h3 class="font-extrabold text-base mt-4 mb-2 border-b border-gray-300 pb-1">INGREDIENTES PRINCIPALES AJUSTADOS:</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-gray-800">
                        <span class="font-bold">Starter Objetivo (${H_S_T}%)</span>
                        <span class="text-lg font-bold">${S_T.toFixed(1)} g</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-800 border-t pt-2">
                        <span class="font-bold">üåæ Harina principal</span>
                        <span class="text-lg font-bold">${RF_Adjusted.toFixed(1)} g</span> 
                        <span class="text-sm">${formatAdjustment(adjustmentHarina)}</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-800">
                        <span class="font-bold">üíß L√≠quido principal (Agua/Leche)</span>
                        <span class="text-lg font-bold">${RL_Adjusted.toFixed(1)} g</span>
                        <span class="text-sm">${formatAdjustment(adjustmentLiquido)}</span>
                    </div>
                </div>

                <div class="mt-4 border-t border-gray-300 pt-3 text-sm text-gray-600">
                    <p>Para mantener la consistencia original, debes usar ${RF_Adjusted.toFixed(1)}g de harina y ${RL_Adjusted.toFixed(1)}g de l√≠quido en tu masa principal.</p>
                </div>
            `;
        }
    </script>
</body>
</html>